<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>زنجیرواژه — WebApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <!-- SF Pro fallback + Vazirmatn -->
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* Design tokens: iOS + Material hybrid */
    :root {
      /* surfaces */
      --bg: #0A0F14;
      --surface-1: rgba(255,255,255,0.05);
      --surface-2: rgba(255,255,255,0.09);
      --surface-3: rgba(255,255,255,0.12);
      --stroke-1: rgba(255,255,255,0.14);
      --stroke-2: rgba(255,255,255,0.18);

      /* text */
      --text: #EAF0F7;
      --muted: #A4B3C5;
      --hint: #88A0B7;

      /* brand */
      --brand: #0A84FF;      /* iOS blue */
      --accent: #00B8A9;     /* Material teal */
      --amber: #FFCC00;      /* iOS amber */
      --success: #34C759;    /* iOS green */
      --danger: #FF3B30;     /* iOS red */

      /* depth + motion */
      --radius: 18px;
      --radius-sm: 12px;
      --blur: 16px;
      --shadow-1: 0 14px 38px rgba(0,0,0,0.35);
      --shadow-2: 0 24px 54px rgba(0,0,0,0.45);
      --ease: cubic-bezier(.22,.61,.36,1);

      /* controls */
      --control-hover: rgba(255,255,255,0.14);
      --control-active: rgba(255,255,255,0.18);

      /* adaptive spacing */
      --pad: clamp(14px, 2.4vw, 20px);
      --gap: clamp(10px, 1.8vw, 16px);
    }

    /* Base */
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, "Helvetica Neue", Arial, "Vazirmatn", sans-serif;
      background:
        radial-gradient(1200px 700px at 85% -20%, #173B59 0%, var(--bg) 45%) fixed,
        linear-gradient(180deg, rgba(10,132,255,0.06), transparent 40%);
    }
    a { color: inherit; text-decoration: none; }

    /* Layout */
    .app {
      max-width: 1024px;
      margin: 0 auto;
      padding: calc(var(--pad) + 8px) var(--pad);
    }

    /* Top bar */
    .topbar {
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: var(--gap);
      margin-bottom: calc(var(--pad) * 0.8);
    }
    .brand {
      display: flex; align-items: center; gap: 12px;
    }
    .logo {
      width: 56px; height: 56px; border-radius: 16px;
      background: linear-gradient(135deg, rgba(255,255,255,0.22), rgba(255,255,255,0.06));
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.14), var(--shadow-1);
      position: relative;
    }
    .logo::after {
      content: 'و';
      position: absolute; inset: 0; display: grid; place-items: center;
      color: var(--brand); font-weight: 800; font-size: 28px;
      text-shadow: 0 0 26px rgba(10,132,255,0.45);
    }
    .title {
      font-weight: 800; letter-spacing: -0.3px;
      font-size: clamp(18px, 2.4vw, 22px);
    }
    .subtitle {
      color: var(--muted); font-size: 13px;
    }
    .actions {
      display: flex; gap: 8px; justify-content: flex-end;
    }

    /* Buttons */
    .btn {
      border: 1px solid var(--stroke-2);
      background: var(--surface-2);
      color: var(--text);
      border-radius: var(--radius-sm);
      padding: 10px 14px;
      font-weight: 600; font-size: 14px;
      transition: transform .08s var(--ease), background .2s var(--ease), box-shadow .25s var(--ease);
      backdrop-filter: blur(var(--blur));
      will-change: transform, box-shadow;
    }
    .btn:hover { transform: translateY(-1px); background: var(--control-hover); }
    .btn:active { transform: translateY(0px) scale(0.99); background: var(--control-active); }
    .btn.primary {
      background: linear-gradient(180deg, rgba(10,132,255,0.35), rgba(10,132,255,0.14));
      border-color: rgba(10,132,255,0.5);
    }
    .btn.accent {
      background: linear-gradient(180deg, rgba(0,184,169,0.35), rgba(0,184,169,0.14));
      border-color: rgba(0,184,169,0.5);
    }
    .btn.ghost { background: rgba(255,255,255,0.08); }

    /* Cards */
    .card {
      background: var(--surface-1);
      border: 1px solid var(--stroke-1);
      border-radius: var(--radius);
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow-2);
      padding: calc(var(--pad) - 2px);
      margin-bottom: var(--pad);
    }

    /* Form controls */
    .row { display: flex; gap: var(--gap); flex-wrap: wrap; align-items: center; }
    .grid { display: grid; gap: var(--gap); grid-template-columns: 1.1fr 0.9fr; }
    @media (max-width: 780px) { .grid { grid-template-columns: 1fr; } }
    .grow { flex: 1; }

    input, select {
      border: 1px solid var(--stroke-2);
      background: var(--surface-3);
      color: var(--text);
      border-radius: var(--radius-sm);
      padding: 12px 14px;
      font-size: 14px;
      outline: none;
      transition: box-shadow .25s var(--ease), border-color .25s var(--ease), background .25s var(--ease);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06);
    }
    input::placeholder { color: var(--hint); }
    input:focus, select:focus {
      border-color: rgba(10,132,255,0.55);
      box-shadow: 0 0 0 3px rgba(10,132,255,0.22);
      background: rgba(255,255,255,0.16);
    }

    /* Status */
    .status {
      display: grid; grid-template-columns: 1fr auto auto; align-items: center; gap: var(--gap);
    }
    .badge {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 8px 12px;
      border: 1px solid var(--stroke-2);
      background: rgba(255,255,255,0.10);
      border-radius: var(--radius-sm);
      font-size: 13px;
    }
    .big-letter {
      font-size: clamp(28px, 3.6vw, 34px);
      font-weight: 900; letter-spacing: -0.6px; color: var(--brand);
      text-shadow: 0 0 28px rgba(10,132,255,0.38);
    }
    .timer {
      width: 48px; height: 48px; border-radius: 12px;
      border: 2px solid rgba(255,255,255,0.30);
      display: grid; place-items: center; font-weight: 800;
      color: var(--amber);
      box-shadow: inset 0 0 14px rgba(255,204,0,0.25);
    }

    /* History + Leaderboard */
    .section-title { margin-bottom: 8px; font-weight: 700; letter-spacing: -0.2px; }
    .history { display: grid; gap: 8px; max-height: 280px; overflow: auto; padding-right: 2px; }
    .entry {
      display: flex; justify-content: space-between; align-items: center;
      background: rgba(255,255,255,0.08);
      border: 1px solid var(--stroke-2);
      border-radius: var(--radius-sm);
      padding: 10px 12px; font-size: 13px;
    }
    .entry .who { color: var(--muted); }
    .ok { color: var(--success); }
    .bad { color: var(--danger); }

    .lb { display: grid; gap: 8px; }
    .lb .row { justify-content: space-between; font-size: 14px; display: flex; }
    .rank {
      min-width: 34px; height: 28px; border-radius: 10px;
      display: grid; place-items: center;
      background: linear-gradient(180deg, rgba(10,132,255,0.22), rgba(10,132,255,0.12));
      border: 1px solid rgba(10,132,255,0.35);
      color: var(--text);
      font-weight: 700;
    }

    /* Micro-interactions */
    .fade-in { animation: fade .28s var(--ease); }
    @keyframes fade { from { opacity: 0; transform: translateY(4px) } to { opacity: 1; transform: translateY(0) } }

    /* Accessibility: focus ring for buttons */
    .btn:focus-visible { box-shadow: 0 0 0 3px rgba(10,132,255,0.25); }
  </style>
</head>
<body>
  <div class="app">
    <!-- Topbar -->
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div class="title">زنجیرواژه</div>
          <div class="subtitle">استاندارد پرمیوم با الهام از iOS و متریال؛ واکنش‌گرا و روان.</div>
        </div>
      </div>
      <div></div>
      <div class="actions">
        <button id="tgBtn" class="btn accent">هماهنگ با تلگرام</button>
      </div>
    </div>

    <!-- Controls + Status -->
    <div class="card fade-in">
      <div class="grid">
        <div>
          <div class="row">
            <input id="name" class="grow" placeholder="نام نمایشی شما">
            <input id="userId" placeholder="شناسه کاربر (مثلاً 1001)">
            <button id="joinBtn" class="btn primary">پیوستن</button>
          </div>
          <div class="row" style="margin-top:10px;">
            <select id="mode">
              <option value="team">Team</option>
              <option value="duel">Duel</option>
              <option value="solo">Solo</option>
            </select>
            <input id="turnSec" type="number" min="5" max="60" value="20" style="max-width:140px" placeholder="زمان نوبت">
            <button id="newBtn" class="btn ghost">شروع بازی جدید</button>
          </div>
        </div>
        <div>
          <div class="status">
            <div class="badge">حرف: <span id="letter" class="big-letter">—</span></div>
            <div class="badge">نوبت: <span id="current">—</span></div>
            <div class="timer" id="timer">0</div>
          </div>
          <div class="row" style="margin-top:10px;">
            <input id="word" class="grow" placeholder="کلمه شما...">
            <button id="submitBtn" class="btn primary">ارسال</button>
          </div>
        </div>
      </div>
    </div>

    <!-- History + Leaderboard -->
    <div class="card fade-in">
      <div class="grid">
        <div>
          <div class="section-title">تاریخچه</div>
          <div id="history" class="history"></div>
        </div>
        <div>
          <div class="section-title">جدول امتیاز</div>
          <div id="lb" class="lb"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Telegram WebApp integration
    const tg = window.Telegram?.WebApp;
    let CHAT_ID = 'local';
    let me = { id: null, name: null };
    let tickHandle = null;

    function initTelegram() {
      try {
        tg?.ready();
        const params = new URLSearchParams(location.search);
        const cid = params.get('chatId');
        if (cid) CHAT_ID = cid;

        const init = tg?.initDataUnsafe;
        if (init?.user) {
          me.id = String(init.user.id);
          me.name = (init.user.first_name || '') + ' ' + (init.user.last_name || '');
          me.name = me.name.trim() || init.user.username || `کاربر ${me.id}`;
          document.getElementById('name').value = me.name;
          document.getElementById('userId').value = me.id;
        }

        tg?.MainButton?.setText('ارسال کلمه');
        tg?.MainButton?.onClick(() => submitWordUI());
      } catch (e) {
        console.warn('Telegram WebApp init error', e);
      }
    }

    const api = {
      async newgame({ mode, turnSeconds }) {
        const res = await fetch('/api/newgame', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ chatId: CHAT_ID, mode, turnSeconds })
        }); return res.json();
      },
      async join({ userId, displayName }) {
        const res = await fetch('/api/join', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ chatId: CHAT_ID, userId, displayName })
        }); return res.json();
      },
      async submit({ userId, word }) {
        const res = await fetch('/api/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ chatId: CHAT_ID, userId, word })
        }); return res.json();
      },
      async state() {
        const res = await fetch(`/api/state?chatId=${CHAT_ID}`); return res.json();
      }
    };

    const el = {
      name: document.getElementById('name'),
      userId: document.getElementById('userId'),
      joinBtn: document.getElementById('joinBtn'),
      mode: document.getElementById('mode'),
      turnSec: document.getElementById('turnSec'),
      newBtn: document.getElementById('newBtn'),
      letter: document.getElementById('letter'),
      current: document.getElementById('current'),
      timer: document.getElementById('timer'),
      word: document.getElementById('word'),
      submitBtn: document.getElementById('submitBtn'),
      history: document.getElementById('history'),
      lb: document.getElementById('lb')
    };

    function fmtName(id, users) {
      const u = users.find(x => String(x.id) === String(id));
      return (u && u.name) ? u.name : `کاربر ${id}`;
    }

    function renderState(s) {
      if (!s || !s.game) {
        el.letter.textContent = '—';
        el.current.textContent = '—';
        el.timer.textContent = '0';
        el.history.innerHTML = '';
        el.lb.innerHTML = '';
        return;
      }
      const g = s.game;
      el.letter.textContent = g.currentLetter || '—';
      el.current.textContent = g.currentPlayerId ? fmtName(g.currentPlayerId, s.users) : '—';
      const left = Math.max(0, Math.floor((g.expiresAt - s.now) / 1000));
      el.timer.textContent = left;

      el.history.innerHTML = '';
      (g.history || []).slice().reverse().forEach(h => {
        const row = document.createElement('div');
        row.className = 'entry';
        const who = fmtName(h.userId, s.users);
        const status = h.valid ? `<span class="ok">درست</span>` : `<span class="bad">نادرست</span>`;
        row.innerHTML = `
          <div class="who">${who} — <strong>${h.word}</strong></div>
          <div>${status} • ${h.score || 0} امتیاز • بعدی: ${h.nextLetter || '—'}</div>
        `;
        el.history.appendChild(row);
      });

      el.lb.innerHTML = '';
      const rows = Object.entries(g.scores || {}).sort((a,b)=>b[1]-a[1]);
      rows.forEach(([uid, sc], i) => {
        const row = document.createElement('div');
        row.className = 'row';
        row.innerHTML = `
          <div style="display:flex;align-items:center;gap:8px;">
            <span class="rank">#${i+1}</span>
            <span>${fmtName(uid, s.users)}</span>
          </div>
          <div>${sc} امتیاز</div>`;
        el.lb.appendChild(row);
      });
    }

    async function sync() {
      const s = await api.state();
      renderState(s);
    }

    function startTick() {
      if (tickHandle) clearInterval(tickHandle);
      tickHandle = setInterval(sync, 1000);
      sync();
    }

    async function submitWordUI() {
      const word = el.word.value.trim();
      if (!me.id) { alert('ابتدا به بازی بپیوندید'); return; }
      if (!word) return;
      const r = await api.submit({ userId: me.id, word });
      if (r.error) alert(r.error);
      if (!r.ok && r.reason) alert(r.reason);
      el.word.value = '';
      sync();
    }

    // Events
    el.joinBtn.addEventListener('click', async () => {
      const id = el.userId.value.trim();
      const name = el.name.value.trim() || `کاربر ${id || 'ناشناخته'}`;
      if (!id) { alert('شناسه کاربر را وارد کنید'); return; }
      const r = await api.join({ userId: id, displayName: name });
      if (r.ok) { me.id = id; me.name = name; startTick(); } else { alert(r.error || 'خطا در پیوستن'); }
    });
    el.newBtn.addEventListener('click', async () => {
      const mode = el.mode.value;
      const turnSeconds = Math.max(5, Math.min(60, Number(el.turnSec.value || 20)));
      const r = await api.newgame({ mode, turnSeconds });
      if (r.ok) startTick();
    });
    el.submitBtn.addEventListener('click', submitWordUI);

    // Auto-init
    if (window.Telegram?.WebApp) initTelegram();
    document.getElementById('tgBtn').addEventListener('click', initTelegram);
    startTick();
  </script>
</body>
</html>
